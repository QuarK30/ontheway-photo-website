# OnTheWay 网页系统 — 快速开发与上线：开发阶段与步骤清单

基于 **tech-stack.mdc**（React + TypeScript、Leaflet/Mapbox、Express、MongoDB、JWT）与 **PRD.md** 整理。  
你只需在 **MongoDB Atlas**、**GitHub**、**部署平台** 上按步骤点选和粘贴；其余代码与配置都在对话里由我完成，你不需要写任何代码。

---

## 一、技术栈对应关系（方便你心里有数）


| 需求        | 技术选型（按 tech-stack）               |
| --------- | -------------------------------- |
| 前端页面      | React + TypeScript，函数组件 + Hooks  |
| 世界地图 + 红点 | Leaflet.js 或 Mapbox GL JS        |
| 页面样式      | TailwindCSS 或 CSS Modules，简约科技感  |
| 后端接口      | Node.js + Express.js，RESTful API |
| 身份区分      | JWT：管理员持 JWT 访问上传/删除等接口，游客仅浏览与留言 |
| 数据库       | MongoDB（云上用 MongoDB Atlas）       |
| 数据模型      | Mongoose                         |
| 请求方式      | Axios 或 Fetch                    |


---

## 二、阶段一：项目骨架（先能跑起来）

**目标**：你本机可以打开一个空白前端页和一个能响应的后端，不涉及数据库。


| 步骤  | 内容                                  | 谁来做 | 说明                                                           |
| --- | ----------------------------------- | --- | ------------------------------------------------------------ |
| 1.1 | 创建前端项目（React + TypeScript + Vite）   | 我   | 在 `photo-website` 下生成前端目录结构、依赖、基础配置，你无需写代码。                  |
| 1.2 | 创建后端项目（Node + Express + TypeScript） | 我   | 在同一仓库下建后端目录（如 `server`），Express + 基础路由，你无需写代码。               |
| 1.3 | 配置依赖与脚本                             | 我   | 前端：地图库、Tailwind、Axios 等；后端：Express、Mongoose、JWT、multer（上传）等。 |
| 1.4 | 本地运行说明                              | 我   | 给你两条命令：启动后端、启动前端。你在本机复制执行，浏览器打开指定地址即可。                       |


**你需要做的**：无。只需在我说「请执行下面命令」时，在终端里复制粘贴我给的命令（安装 Node 若尚未安装，我会给你下载链接和安装步骤）。

**阶段一结束 · 测试步骤**

1. 在项目根目录打开终端，进入后端：`cd server`，执行 `npm install`（若未执行过），再执行 `npm run dev`，看到类似「OnTheWay server listening on http://localhost:4000」即表示后端已启动。
2. 新开一个终端，进入前端：`cd client`，执行 `npm install`（若未执行过），再执行 `npm run dev`，看到本地地址（如 http://localhost:5173）。
3. 浏览器访问上述前端地址，能打开页面、无报错；访问 http://localhost:4000/health，页面显示 `{"status":"ok",...}` 即表示前后端均正常。

---

## 三、阶段二：数据库（MongoDB Atlas）

**目标**：在云端有一个 MongoDB 数据库，后端能连上它；你只需在网页上点选和复制连接串。


| 步骤  | 内容                           | 谁来做 | 说明                                                             |
| --- | ---------------------------- | --- | -------------------------------------------------------------- |
| 2.1 | 注册 / 登录 MongoDB Atlas，创建免费集群 | 你   | 我会写：打开哪个网址、点「Create Cluster」、选哪个区域、集群名填什么（可复制）。                |
| 2.2 | 创建数据库用户（给后端用）                | 你   | 我会写：在 Atlas 点哪里、用户名和密码填什么（你可自改，我会给你示例），复制保存。                   |
| 2.3 | 获取连接字符串                      | 你   | 在 Atlas 点「Connect」→ 选「Drivers」→ 复制连接串；我会告诉你在哪里把密码替换成 2.2 的密码。  |
| 2.4 | 设计并实现数据模型（Mongoose）          | 我   | 照片（含 location、imageUrl、标题、描述）、留言（关联图片、昵称、内容、是否隐藏）、管理员用户；我写好代码。 |
| 2.5 | 后端连接 MongoDB + 环境变量说明        | 我   | 我写 `.env.example` 和连接逻辑；你本地新建 `.env`，把连接串贴进去（我告诉你变量名和格式）。      |


**你需要做的**：在 MongoDB Atlas 按我步骤创建集群、建用户、复制连接串，并在本机 `.env` 里粘贴（不提交到 GitHub）。

**阶段二结束 · 测试步骤**

1. 确认 `server/.env` 中已填写 `MONGODB_URI`（连接串中密码已替换为你的数据库用户密码）。
2. 重启后端：在 `server` 目录执行 `npm run dev`，终端中应出现「MongoDB connected」或类似成功连接日志，无报错。
3. 若连接失败，检查 Atlas 中该用户的 IP 是否已加入白名单（或暂时允许 0.0.0.0/0），以及连接串、密码是否正确。

---

## 四、阶段三：后端 API（Express + JWT）

**目标**：后端提供完整接口：管理员登录、照片 CRUD、上传、留言 CRUD；所有需权限的接口校验 JWT。


| 步骤  | 内容             | 谁来做 | 说明                                                                                              |
| --- | -------------- | --- | ----------------------------------------------------------------------------------------------- |
| 3.1 | 管理员登录接口（发 JWT） | 我   | POST 邮箱+密码，校验通过后返回 JWT；仅用于管理员，不开放注册。                                                            |
| 3.2 | 照片相关接口         | 我   | 获取列表（含经纬度，供地图红点）、按 ID 获取详情、上传（multer 存文件，元数据写 MongoDB，含 location、imageUrl）、编辑、删除；上传/编辑/删除需 JWT。 |
| 3.3 | 留言相关接口         | 我   | 按图片 ID 获取留言列表、发表留言（关联图片 ID、昵称、内容）；管理员删除/隐藏留言接口（需 JWT）。                                          |
| 3.4 | 图片文件存储与访问方式    | 我   | 上传到后端 `uploads`（或你后续要用的目录），提供静态访问或 GET 接口；部署时用持久化磁盘或后续加云存储。                                     |
| 3.5 | JWT 中间件与 CORS  | 我   | 需要管理员权限的接口统一校验 JWT；CORS 允许前端域名，方便本地和上线后访问。                                                      |


**你需要做的**：无。若需要「第一个管理员账号」，我会告诉你在 Atlas 里往某个集合插入一条用户记录，或提供一个一次性脚本你运行一次（你只运行命令，不写代码）。

**阶段三结束 · 测试步骤**

1. **创建管理员**：在 `server` 目录执行 `npm run create-admin`（需在 `.env` 中已配置 `ADMIN_EMAIL`、`ADMIN_PASSWORD`），看到「管理员账号创建成功」。
2. **登录**：用 Postman、curl 或浏览器控制台请求 `POST http://localhost:4000/auth/login`，body 为 `{"email":"你的邮箱","password":"你的密码"}`，应返回 `{ "token": "...", "email": "..." }`。
3. **照片接口**：未带 token 时 `POST http://localhost:4000/photos` 应返回 401；带 Header `Authorization: Bearer <上一步的 token>` 且 body（或 FormData）含 title、lat、lng、image 时，应返回 201 及照片数据。
4. **留言接口**：`GET http://localhost:4000/photos/<某照片id>/comments` 应返回数组；`POST http://localhost:4000/photos/<某照片id>/comments`，body `{ "nickname":"测试","content":"一条留言" }` 应返回 201。
5. **静态图片**：上传一张照片后，访问 `http://localhost:4000/uploads/<返回的文件名>` 应能打开图片。

---

## 五、阶段四：前台页面（游客 + 地图 + 图片 + 留言）

**目标**：游客能打开首页地图、看红点、点红点进图片、看详情与留言，并能设昵称和发留言。


| 步骤  | 内容                            | 谁来做 | 说明                                                         |
| --- | ----------------------------- | --- | ---------------------------------------------------------- |
| 4.1 | 首页：世界地图（Leaflet 或 Mapbox）+ 红点 | 我   | 从后端拉取带经纬度的照片列表，同一地点多张图可合并为一个红点；支持滚轮缩放、拖拽平移；风格偏深色/简约。 |
| 4.2 | 红点点击 → 直接进入该地点某张图片详情           | 我   | 点击红点直接跳转到该地点对应的某张图片详情页（不先进入列表）；若该地点有多张图片，默认进入其中一张（如第一张）。 |
| 4.3 | 图片详情页 + 同地点多图左右切换                 | 我   | 详情页展示高清大图、标题、描述、拍摄日期，带加载状态（占位/骨架）；若该地点有多张图片，详情页内提供左箭头/右箭头（或左滑、右滑）在同一地点的不同图片之间切换，无需返回地图。 |
| 4.4 | 游客昵称：进入时自填 or 随机，可多次随机        | 我   | 首次进入弹窗或区域：输入昵称 or 点「随机生成」，不满意可多次随机；存 localStorage，留言时用该昵称。 |
| 4.5 | 留言：按图片发表 + 展示                 | 我   | 详情页有留言列表和发表框，提交时带当前昵称和图片 ID；样式简约。                          |


**你需要做的**：无。

**阶段四结束 · 测试步骤**

1. **首页地图**：访问前端首页，应看到世界地图；若数据库中有照片，地图上出现红点（同一地点多张图可合并为一个红点）；滚轮可缩放、拖拽可平移。
2. **红点与详情**：点击任一红点，应**直接**跳转到该地点某张图片的详情页（不经过列表）；详情页展示大图、标题、描述、拍摄日期；大图加载过程中应有骨架或占位。
3. **同地点多图切换**：若该地点有多张图片，详情页内应出现左箭头、右箭头（或支持左滑/右滑）；点击或滑动可在同一地点的多张图片之间切换，无需返回地图。
4. **昵称**：首次访问时（或清除 localStorage 后刷新）应弹出昵称设置弹窗；可输入昵称或点「随机生成」后确定；在详情页留言区可点「修改昵称」再次打开弹窗。
5. **留言**：在详情页填写留言内容并「发表」，应成功提交且列表中立即出现刚发的留言（昵称、时间、内容正确）；刷新页面后该留言仍存在。

---

## 六、阶段五：管理后台（仅管理员）

**目标**：管理员登录后能上传照片、编辑描述与地点、管理留言；未登录访问后台会跳到登录页。


| 步骤  | 内容                 | 谁来做 | 说明                                                             |
| --- | ------------------ | --- | -------------------------------------------------------------- |
| 5.1 | 登录页（邮箱 + 密码，拿 JWT） | 我   | 调用后端登录接口，把返回的 JWT 存起来（如 localStorage 或内存），后续请求在 Header 里带 JWT。 |
| 5.2 | 后台路由保护             | 我   | 访问后台页时若没有有效 JWT，重定向到登录页。                                       |
| 5.3 | 照片管理               | 我   | 上传（单张/多张）、编辑标题/描述/经纬度（或地点名）、删除；列表展示已有照片。                       |
| 5.4 | 留言管理               | 我   | 查看所有留言、按图片筛选、删除、隐藏/显示。                                         |


**你需要做的**：按我说明在数据库里创建一条管理员账号（或运行我提供的一条命令/脚本），之后用该邮箱密码在登录页登录。

**阶段五结束 · 测试步骤**

1. **未登录访问**：在未登录状态下访问 `/admin/photos` 或 `/admin/comments`，应被重定向到 `/admin/login`。
2. **登录**：在登录页输入阶段三创建的管理员邮箱和密码，提交后应跳转到照片管理页，且不再被重定向到登录页。
3. **照片管理**：上传一张新照片（标题、描述、地点、经纬度、拍摄日期、图片文件），提交后列表中出现该照片；点击「编辑」可修改标题/描述/地点/经纬度/拍摄日期并保存；点击「删除」确认后该照片从列表消失，首页地图上对应红点消失。
4. **留言管理**：进入「留言管理」，应看到所有留言；可按图片筛选；对某条留言执行「隐藏」后，前台该照片详情页中该条留言不再显示；执行「删除」后该条留言从列表消失。

---

## 七、阶段六：风格与体验（简约科技感）

**目标**：整站符合 PRD 的视觉与体验要求。


| 步骤  | 内容      | 谁来做 | 说明                                              |
| --- | ------- | --- | ----------------------------------------------- |
| 7.1 | 全局样式    | 我   | 深色或中性背景、留白、现代无衬线字体；Tailwind 或 CSS Modules 统一变量。 |
| 7.2 | 地图与红点样式 | 我   | 地图深色/低饱和；红点醒目；动效克制。                             |
| 7.3 | 大图加载与过渡 | 我   | 占位图/骨架/进度条；页面切换简单过渡。                            |


**你需要做的**：无。

**阶段六结束 · 测试步骤**

1. **全局样式**：整站为深色或中性背景、留白合理、字体为无衬线；无大面积错位或样式错乱。
2. **地图与红点**：地图风格与整站一致；红点清晰可见（如带光晕或描边）；地图上光标为小手且易辨认。
3. **大图与过渡**：进入照片详情页时，大图加载前有骨架或占位动画；从首页进入详情或返回时，有简单淡入/过渡效果，无生硬闪屏。

---

## 八、阶段七：部署与上线（所有人能访问）

**目标**：前端、后端、数据库都在线上，任何人通过一个网址即可访问。

**详细步骤见根目录 [DEPLOYMENT.md](./DEPLOYMENT.md)**，其中包含：
- **MongoDB 说明**：阶段二若您使用了**本地 MongoDB**，上线时后端在云端无法连本机，必须改用**云端数据库**；DEPLOYMENT.md 以 **Railway MongoDB** 为主方案（推荐），备选为 MongoDB Atlas。
- 8.1～8.6 的逐步操作（GitHub、Render 后端、Vercel 前端、Atlas/Railway 数据库、自测清单）。


| 步骤  | 内容                       | 谁来做   | 说明                                                                |
| --- | ------------------------ | ----- | ----------------------------------------------------------------- |
| 8.1 | 准备部署用配置                  | 我     | 前端生产构建、后端生产运行方式；环境变量清单（API 地址、**云端** MongoDB 连接串、JWT 密钥等）。   |
| 8.2 | 在 GitHub 创建仓库并推送代码       | 你 + 我 | 我给出「点哪里、填什么」的步骤，以及你在本机执行的 2～3 条 git 命令（复制粘贴）。                     |
| 8.3 | 部署后端（如 Render / Railway） | 你 + 我 | 用哪个平台、根目录填 `server`、环境变量名和值从哪里复制。                              |
| 8.4 | 部署前端（如 Vercel）           | 你 + 我 | Vercel 连 GitHub、根目录填 `client`、环境变量 VITE_API_URL=后端地址。                  |
| 8.5 | 云端 MongoDB（Railway 推荐）     | 你     | 上线必须用云端数据库；DEPLOYMENT.md 以 Railway MongoDB 为主、Atlas 为备选。                   |
| 8.6 | 上线后自测清单                  | 我 + 你 | 打开首页、地图红点、点红点进详情、同地点多图切换、留言、管理员登录、上传/管理照片与留言。                  |


**你需要做的**：按 DEPLOYMENT.md 在 GitHub 建仓推送、Render 部署后端、Vercel 部署前端、配置**云端** MongoDB；全部用「点哪里、填什么、复制什么」的大白话说清楚。

**阶段七结束 · 测试步骤（见 DEPLOYMENT.md 8.6 上线后自测清单）**

部署完成后，按 **8.6** 提供的自测清单逐项操作：在线上环境打开首页 → 看地图与红点 → 点红点直接进某张图片详情 → 若该地点有多张图，在详情页用左右箭头（或左滑/右滑）切换 → 游客留言 → 管理员登录 → 上传/编辑/删除照片 → 管理留言（筛选、隐藏、删除）。全部通过即表示阶段七验收通过；若有异常，记录现象与页面地址反馈即可。

---

## 九、你需要提前准备的东西

1. **Node.js**
  若未安装，我会给你下载链接和「下一步」式安装说明；需要 LTS 版本即可。
2. **MongoDB Atlas 账号**
  打开 [https://www.mongodb.com/cloud/atlas](https://www.mongodb.com/cloud/atlas) 用邮箱注册即可（免费层够用）。
3. **GitHub 账号**
  打开 [https://github.com](https://github.com) 注册/登录；用于存代码和配合 Vercel/Render 部署。
4. **管理员邮箱和密码**
  用于在系统里唯一的管理员账号（我会教你在库里插入或通过脚本创建，你只填邮箱和密码）。

---

## 十、执行顺序小结

1. **阶段一**：我建好前端+后端骨架并写好启动说明 → 你本机执行两条命令，能打开页面、接口能通。
2. **阶段二**：你按步骤在 Atlas 建集群、建用户、拿连接串；我写好 Mongoose 模型和 `.env` 说明 → 你在本机填 `.env`。
3. **阶段三**：我写完所有后端接口 → 你本机重启后端，我带你用接口测一下（或你按我清单点一点）。
4. **阶段四～六**：我完成前台页面、管理后台、风格 → 你本机刷新页面逐项看效果。
5. **阶段七**：你按步骤 GitHub 建仓推送、Render 部署后端、Vercel 部署前端、Atlas 白名单 → 我提供自测清单，你点一遍确认「所有人能访问」。

---

## 十一、若需要你在平台上的操作，我会怎么写

- **MongoDB Atlas**：例如「打开 [https://cloud.mongodb.com](https://cloud.mongodb.com) → 登录 → 左侧点 Project → 点 Create Project → Name 填 `OnTheWay` → Create」；需要你复制的内容我会用引用块或代码块给出，你直接粘贴即可。  
- **GitHub**：例如「点 New repository → Repository name 填 `photo-website` → 下面选 Private 或 Public → Create repository」；然后给你本机要执行的 `git remote add ...` 和 `git push ...` 完整命令。  
- **Render / Vercel**：例如「在 Dashboard 点 New → Web Service → 连接 GitHub → 选 `photo-website` → Root Directory 填 `server` → 在 Environment 里添加变量：`MONGODB_URI`，值粘贴你的 Atlas 连接串」。

---

请你确认：  

- 这份「阶段 + 步骤」是否同意？有想增加、合并或删掉的步骤可以直接说。  
- 确认后我们从 **阶段一** 开始，一步一步做到「所有人能登录访问的上线网页」。  
- 若你希望后端或前端用别的部署平台（例如只要 Vercel 全栈，或指定 Railway），也可以先说，我会在阶段七的说明里改成对应平台的操作步骤。

